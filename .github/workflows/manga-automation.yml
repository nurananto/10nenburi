name: Manga Automation

on:
  push:
    branches:
      - main
    paths:
      - '**/*.jpg'
      - '**/*.jpeg'
      - '**/*.png'
      - '**/*.webp'
      - 'manga-config.json'
  
  schedule:
    - cron: '0 0 * * *'
  
  workflow_dispatch:

permissions:
  contents: write

jobs:
  manga-automation:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      
      - name: Generate manga.json and chapters.json with Git timestamps
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          import json
          import subprocess
          import re
          from datetime import datetime

          print("🚀 Starting manga automation with Git timestamps...")
          print("")

          def get_git_commit_date(folder_path):
              """Get Git commit date for a specific folder"""
              try:
                  result = subprocess.run(
                      ['git', 'log', '-1', '--format=%aI', '--', folder_path],
                      capture_output=True,
                      text=True,
                      check=True
                  )
                  commit_date = result.stdout.strip()
                  
                  if commit_date:
                      return commit_date
                  else:
                      result = subprocess.run(
                          ['git', 'log', '--reverse', '--format=%aI', '--', folder_path],
                          capture_output=True,
                          text=True,
                          check=True
                      )
                      first_commit = result.stdout.strip().split('\n')[0]
                      if first_commit:
                          return first_commit
                      else:
                          return datetime.utcnow().isoformat() + 'Z'
                      
              except Exception as e:
                  print(f"  ⚠️  Error getting git date for {folder_path}: {e}")
                  return datetime.utcnow().isoformat() + 'Z'

          def is_chapter_folder(folder_name):
              """Check if folder is a chapter (supports: 1, 2, 1.1, 1.2, 2.1, etc)"""
              # Match: pure numbers (1, 2, 3) or decimal (1.1, 2.5, 10.2)
              pattern = r'^\d+(\.\d+)?$'
              return re.match(pattern, folder_name) is not None

          def parse_chapter_number(folder_name):
              """Parse chapter number from folder name (supports decimals)"""
              try:
                  return float(folder_name)
              except:
                  return 0.0

          # Scan directories for chapters
          print("📂 Scanning for chapters (supports decimal numbers)...")
          chapters = {}
          chapter_list = []
          
          for item in sorted(os.listdir('.')):
              if os.path.isdir(item) and is_chapter_folder(item):
                  chapter_num = parse_chapter_number(item)
                  upload_date = get_git_commit_date(item)
                  
                  image_files = [f for f in os.listdir(item) 
                                if f.lower().endswith(('.jpg', '.jpeg', '.png', '.webp'))]
                  
                  # Title: "Chapter 1" or "Chapter 1.1" etc
                  if chapter_num.is_integer():
                      title = f"Chapter {int(chapter_num)}"
                      chapter_key = str(int(chapter_num))
                  else:
                      title = f"Chapter {chapter_num}"
                      chapter_key = str(chapter_num)
                  
                  chapter_data = {
                      "title": title,
                      "chapter": chapter_num,
                      "uploadDate": upload_date,
                      "totalPages": len(image_files),
                      "locked": False
                  }
                  
                  chapters[chapter_key] = chapter_data
                  chapter_list.append(chapter_data)
                  print(f"  ✅ {item}: {title} ({len(image_files)} pages) - {upload_date}")
          
          print("")
          print(f"✅ Found {len(chapter_list)} chapters")
          
          # Sort chapters by number (descending - newest first)
          chapter_list.sort(key=lambda x: x['chapter'], reverse=True)
          
          last_chapter_update = None
          if chapter_list:
              last_chapter_update = chapter_list[0]['uploadDate']
              print(f"📅 Last chapter update: {last_chapter_update}")
          else:
              print("⚠️  No chapters found!")
          
          repo_name = os.path.basename(os.getcwd())
          
          manga_data = {
              "manga": {
                  "title": repo_name,
                  "cover": "cover.jpg",
                  "views": 0
              },
              "lastChapterUpdate": last_chapter_update,
              "lastUpdated": datetime.utcnow().isoformat() + 'Z',
              "chapters": chapters
          }
          
          chapters_data = {
              "chapters": chapter_list
          }
          
          print("")
          print("💾 Writing files...")
          with open('manga.json', 'w', encoding='utf-8') as f:
              json.dump(manga_data, f, indent=2, ensure_ascii=False)
          
          with open('chapters.json', 'w', encoding='utf-8') as f:
              json.dump(chapters_data, f, indent=2, ensure_ascii=False)
          
          print("✅ Files created successfully!")
          print("")
          print("=" * 50)
          print(f"Manga: {repo_name}")
          print(f"Total Chapters: {len(chapter_list)}")
          if chapter_list:
              print(f"Latest Chapter: {chapter_list[0]['title']}")
          print(f"Last Update: {last_chapter_update}")
          print("=" * 50)
          PYTHON_SCRIPT
      
      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          git pull origin main --rebase || true
          git add manga.json chapters.json 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "✅ No changes to commit"
          else
            if [ "${{ github.event_name }}" = "push" ]; then
              COMMIT_MSG="📚 Auto-update manga data [skip ci]"
            elif [ "${{ github.event_name }}" = "schedule" ]; then
              COMMIT_MSG="📊 Daily metadata refresh [skip ci]"
            else
              COMMIT_MSG="📄 Manual update [skip ci]"
            fi
            
            git commit -m "$COMMIT_MSG"
            
            max_retries=3
            count=0
            until git push origin main; do
              count=$((count+1))
              if [ $count -eq $max_retries ]; then
                echo "❌ Failed to push after $max_retries attempts"
                exit 1
              fi
              echo "⚠️  Retrying push... (attempt $count/$max_retries)"
              sleep 5
              git pull origin main --rebase
            done
            
            echo "✅ Successfully pushed changes"
          fi
      
      - name: Show Summary
        if: always()
        run: |
          echo ""
          echo "╔════════════════════════════════════════╗"
          echo "║       AUTOMATION SUMMARY               ║"
          echo "╚════════════════════════════════════════╝"
          echo "Trigger: ${{ github.event_name }}"
          echo "Time: $(date)"
          echo ""
          
          if [ -f manga.json ]; then
            echo "📊 Manga Stats:"
            MANGA_TITLE=$(jq -r '.manga.title' manga.json)
            TOTAL_CHAPTERS=$(jq '.chapters | length' manga.json)
            LAST_UPDATE=$(jq -r '.lastChapterUpdate // "N/A"' manga.json)
            
            echo "  Title: $MANGA_TITLE"
            echo "  Total Chapters: $TOTAL_CHAPTERS"
            echo "  Last Update: $LAST_UPDATE"
          fi
          
          echo "╚════════════════════════════════════════╝"
